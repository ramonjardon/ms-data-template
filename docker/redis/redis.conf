# Configuración de Redis con TLS (rediss://)
# Optimizado para 1GB RAM, 1 CPU

# ============================================
# RED Y SEGURIDAD
# ============================================

# Puerto TLS (rediss)
tls-port 6380
port 0

# Autenticación
requirepass redis_password

# TLS/SSL
tls-cert-file /tls/redis.crt
tls-key-file /tls/redis.key
tls-ca-cert-file /tls/ca.crt
tls-auth-clients no

# ============================================
# MEMORIA
# ============================================

# Límite de memoria (90% de 1GB = 900MB)
maxmemory 900mb

# Política de evicción: LRU en todas las claves
maxmemory-policy allkeys-lru

# Samples para LRU (más alto = más preciso pero más CPU)
maxmemory-samples 5

# ============================================
# PERSISTENCIA (AOF)
# ============================================

# Habilitar AOF (Append Only File)
appendonly yes

# Nombre del archivo AOF
appendfilename "appendonly.aof"

# Sincronización cada segundo (balance rendimiento/seguridad)
appendfsync everysec

# No fsync durante rewrite
no-appendfsync-on-rewrite no

# Auto-rewrite del AOF
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ============================================
# OPTIMIZACIÓN CPU
# ============================================

# IO threads (para 1 CPU, usar 2-3 threads)
io-threads 2
io-threads-do-reads yes

# Deshabilitar comandos peligrosos
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""

# ============================================
# TIMEOUTS Y LIMITES
# ============================================

# Timeout de conexión inactiva (5 minutos)
timeout 300

# TCP keepalive
tcp-keepalive 300

# Máximo de clientes
maxclients 1000

# ============================================
# LOGGING
# ============================================

# Nivel de log
loglevel notice

# Log a stdout (Docker captura esto)
logfile ""

# ============================================
# SNAPSHOTS (RDB) - DESHABILITADO
# ============================================

# Deshabilitamos snapshots porque usamos AOF
save ""

# ============================================
# OPTIMIZACIONES AVANZADAS
# ============================================

# Hash tables
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# Lists
list-max-ziplist-size -2
list-compress-depth 0

# Sets
set-max-intset-entries 512

# Sorted Sets
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog
hll-sparse-max-bytes 3000

# Streams
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active defragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25

# Lazy freeing
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes
lazyfree-lazy-user-del yes
